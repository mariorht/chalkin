<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sesi√≥n - Chalkin</title>
    
    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="16x16" href="/static/icons/logoChalkin_invertido_16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/icons/logoChalkin_invertido_32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/icons/logoChalkin_invertido_180.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#FF6B35">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Chalkin">
    
    <link rel="stylesheet" href="/static/css/app-shell.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #FF6B35;
            --primary-dark: #E55A2B;
            --secondary: #2EC4B6;
            --dark: #1A1A2E;
            --light: #F7F7F7;
            --gray: #6B7280;
            --error: #EF4444;
            --success: #22C55E;
            --flash: #F59E0B;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--light);
        }

        /* Header base styles in app-shell.css */

        body.active-session {
            padding-bottom: 180px; /* Extra space for end session button */
        }

        .main-container {
            max-width: 600px;
            margin: 0 auto;
            margin-top: 15px;
            padding: 1.5rem;
            position: relative;
            z-index: 1; /* Por debajo del status bar (z-index: 999) */
        }

        /* Session info */
        .session-info {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.5rem;
        }

        .session-info h1 {
            color: var(--dark);
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .title-edit-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            opacity: 0.5;
            transition: opacity 0.2s;
            padding: 0.25rem;
        }

        .title-edit-btn:hover {
            opacity: 1;
        }

        .title-editor {
            display: none;
            margin-bottom: 1rem;
        }

        .title-editor.active {
            display: block;
        }

        .title-editor input {
            width: 100%;
            padding: 0.6rem 0.8rem;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 0.5rem;
            font-family: inherit;
        }

        .title-editor input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .title-editor input::placeholder {
            color: #999;
        }

        .title-editor-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .title-editor-buttons button {
            flex: 1;
            padding: 0.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-save-title {
            background: var(--primary);
            color: white;
        }

        .btn-cancel-title {
            background: #E5E7EB;
            color: var(--gray);
        }

        .session-meta {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .session-duration {
            color: var(--dark);
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Stats summary */
        .session-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #E5E7EB;
        }

        .mini-stat {
            text-align: center;
        }

        .mini-stat .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
        }

        .mini-stat .label {
            font-size: 0.8rem;
            color: var(--gray);
        }

        /* Grade selector */
        .grade-selector {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.5rem;
        }

        .grade-selector h2 {
            color: var(--dark);
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }

        .grades-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.75rem;
        }

        .grade-btn {
            aspect-ratio: 1;
            border: 3px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: white;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .grade-btn:hover {
            transform: scale(1.05);
        }

        .grade-btn.selected {
            border-color: var(--dark);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .grade-btn .grade-name {
            font-size: 0.9rem;
        }

        /* Status selector */
        .status-selector {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .status-btn {
            flex: 1;
            padding: 0.8rem;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.3rem;
        }

        .status-btn:hover {
            border-color: var(--gray);
        }

        .status-btn.selected {
            border-color: var(--primary);
            background: rgba(255, 107, 53, 0.05);
        }

        .status-btn svg {
            color: var(--gray);
            transition: color 0.2s;
        }

        .status-btn.selected svg {
            color: var(--primary);
        }

        .status-btn .label {
            font-size: 0.85rem;
            color: var(--dark);
            font-weight: 600;
        }

        .status-btn.flash.selected {
            border-color: var(--flash);
            background: rgba(245, 158, 11, 0.1);
        }

        .status-btn.flash.selected svg {
            color: var(--flash);
        }

        .status-btn.send.selected {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.1);
        }

        .status-btn.send.selected svg {
            color: var(--success);
        }

        .status-btn.repeat.selected {
            border-color: var(--secondary);
            background: rgba(46, 196, 182, 0.1);
        }

        .status-btn.repeat.selected svg {
            color: var(--secondary);
        }

        .status-btn.project.selected {
            border-color: var(--flash);
            background: rgba(245, 158, 11, 0.1);
        }

        .status-btn.project.selected svg {
            color: var(--flash);
        }

        /* Add button */
        .add-btn {
            width: 100%;
            padding: 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.2s;
        }

        .add-btn:hover {
            background: var(--primary-dark);
        }

        .add-btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
        }

        /* Ascents list */
        .ascents-section {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .ascents-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #E5E7EB;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ascents-header h2 {
            color: var(--dark);
            font-size: 1rem;
        }

        .ascent-item {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #F3F4F6;
            gap: 1rem;
        }

        .ascent-item:last-child {
            border-bottom: none;
        }

        .ascent-grade {
            min-width: 70px;
            height: 45px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            font-size: 0.85rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .ascent-info {
            flex: 1;
        }

        .ascent-info .grade-label {
            font-weight: 600;
            color: var(--dark);
        }

        .ascent-info .time {
            font-size: 0.85rem;
            color: var(--gray);
        }

        .ascent-status {
            font-size: 1.2rem;
        }

        .ascent-delete {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            padding: 0.5rem;
            font-size: 1rem;
            transition: color 0.2s;
        }

        .ascent-delete:hover {
            color: var(--error);
        }

        .empty-ascents {
            padding: 2rem;
            text-align: center;
            color: var(--gray);
        }

        /* Fixed bottom bar (above bottom nav) */
        .bottom-bar {
            position: fixed;
            bottom: var(--bottom-nav-height, 70px);
            left: 0;
            right: 0;
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: center;
            z-index: 999;
        }

        .end-session-btn {
            background: var(--error);
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .end-session-btn:hover {
            background: #DC2626;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--gray);
        }

        /* Summary section for ended sessions */
        .summary-section {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.5rem;
        }

        .summary-section h2 {
            color: var(--dark);
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }

        .grade-breakdown {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .grade-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .grade-row .grade-color {
            min-width: 70px;
            height: 30px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            font-size: 0.7rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .grade-row .grade-info {
            flex: 1;
        }

        .grade-row .grade-name {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
        }

        .grade-row .grade-count {
            color: var(--gray);
            font-size: 0.85rem;
        }

        /* Back to dashboard button (for ended sessions) */
        .back-btn {
            display: inline-block;
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            margin-top: 1.5rem;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: var(--primary-dark);
        }

        .btn-reopen {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background: var(--secondary);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            margin-top: 1.5rem;
            margin-left: 1rem;
            transition: all 0.2s;
        }

        .btn-reopen:hover {
            background: #25A89D;
            transform: translateY(-2px);
        }

        .btn-primary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-delete {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background: var(--error);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            margin-top: 1.5rem;
            margin-left: 1rem;
            transition: all 0.2s;
        }

        .btn-delete:hover {
            background: #DC2626;
            transform: translateY(-2px);
        }

        .btn-strava {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background: white;
            color: #FC4C02;
            border: 2px solid #FC4C02;
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            transition: all 0.2s;
            flex: 1;
        }

        .btn-strava img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        .btn-strava:hover {
            background: #FFF4ED;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(252, 76, 2, 0.2);
        }

        .btn-strava:disabled {
            background: #f5f5f5;
            color: #cccccc;
            border-color: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-strava.uploaded {
            background: var(--success);
            cursor: default;
        }

        .btn-strava.uploaded:hover {
            background: var(--success);
            transform: none;
        }

        .btn-share {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background: var(--secondary);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            transition: all 0.2s;
            flex: 1;
        }

        .btn-share:hover {
            background: #25A89D;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 196, 182, 0.3);
        }

        .btn-share:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Session status bar -->
    <div id="sessionStatusBar" style="position: fixed; top: var(--header-height, 60px); left: 0; right: 0; background: var(--dark); padding: 0.5rem 1rem; display: flex; justify-content: space-between; align-items: center; z-index: 999; border-bottom: 1px solid rgba(255,255,255,0.1);">
        <span class="session-status-badge active" id="statusBadge" style="background: var(--success); color: white; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">En curso</span>
        <span id="timerContainer" style="color: var(--secondary); font-weight: 700;">‚è±Ô∏è <span id="timer">00:00</span></span>
    </div>

    <main class="main-container" style="padding-top: 40px;">
        <section class="session-info" id="sessionInfo">
            <h1 id="sessionTitle">
                <span id="gymName">Cargando...</span>
                <button class="title-edit-btn" id="editTitleBtn" title="Editar t√≠tulo">‚úèÔ∏è</button>
            </h1>
            
            <!-- Editor de t√≠tulo (oculto por defecto) -->
            <div class="title-editor" id="titleEditor">
                <input type="text" id="editTitleInput" placeholder="T√≠tulo de la sesi√≥n" maxlength="100">
                <input type="text" id="editSubtitleInput" placeholder="Subt√≠tulo (opcional)" maxlength="200">
                <div class="title-editor-buttons">
                    <button class="btn-cancel-title" id="cancelTitleBtn">Cancelar</button>
                    <button class="btn-save-title" id="saveTitleBtn">Guardar</button>
                </div>
            </div>
            
            <p class="session-subtitle hidden" id="sessionSubtitle" style="color: var(--gray); font-size: 0.95rem; margin-bottom: 0.5rem;"></p>
            <p class="session-meta" id="sessionMeta"></p>
            <p class="session-duration hidden" id="sessionDuration"></p>
            
            <div class="session-stats">
                <div class="mini-stat">
                    <div class="value" id="totalAscents">0</div>
                    <div class="label">Bloques</div>
                </div>
                <div class="mini-stat">
                    <div class="value" id="totalFlashes">0</div>
                    <div class="label">Flashes</div>
                </div>
                <div class="mini-stat">
                    <div class="value" id="totalSends">0</div>
                    <div class="label">Sends</div>
                </div>
                <div class="mini-stat">
                    <div class="value" id="maxGrade">-</div>
                    <div class="label">M√°x grado</div>
                </div>
            </div>
        </section>

        <!-- Summary section (only for ended sessions) -->
        <section class="summary-section hidden" id="summarySection">
            <h2>üìä Resumen por grado</h2>
            <div class="grade-breakdown" id="gradeBreakdown">
                <!-- Filled by JS -->
            </div>
        </section>

        <section class="grade-selector" id="gradeSelector">
            <h2>Registrar bloque</h2>
            <div class="grades-grid" id="gradesGrid">
                <div class="loading">Cargando grados...</div>
            </div>
            
            <div class="status-selector">
                <button type="button" class="status-btn flash" data-status="flash">
                    <svg viewBox="0 0 24 24" fill="currentColor" style="width:18px;height:18px;"><path d="M7 2v11h3v9l7-12h-4l4-8z"/></svg>
                    <span class="label">Flash</span>
                </button>
                <button type="button" class="status-btn send" data-status="send">
                    <svg viewBox="0 0 24 24" fill="currentColor" style="width:18px;height:18px;"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    <span class="label">Send</span>
                </button>
                <button type="button" class="status-btn repeat" data-status="repeat">
                    <svg viewBox="0 0 24 24" fill="currentColor" style="width:18px;height:18px;"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>
                    <span class="label">Repetici√≥n</span>
                </button>
                <button type="button" class="status-btn project" data-status="project">
                    <svg viewBox="0 0 24 24" fill="currentColor" style="width:18px;height:18px;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                    <span class="label">Proyecto</span>
                </button>
            </div>
            
            <button class="add-btn" id="addAscentBtn" disabled>
                + A√±adir bloque
            </button>
        </section>

        <section class="ascents-section">
            <div class="ascents-header">
                <h2 id="ascentsTitle">Bloques de hoy</h2>
            </div>
            <div id="ascentsList">
                <div class="empty-ascents">
                    A√∫n no has registrado ning√∫n bloque
                </div>
            </div>
        </section>
    </main>

    <div class="bottom-bar" id="bottomBar">
        <button class="end-session-btn" onclick="endSession()">
            üõë Terminar sesi√≥n
        </button>
    </div>

    <script src="/static/js/app-shell.js"></script>
    <script>
        // Inicializar App Shell
        AppShell.init({ activePage: 'sessions' });
        
        const API_URL = '/api';
        const token = AppShell.token;
        const sessionId = window.location.pathname.split('/').pop();
        
        let session = null;
        let grades = [];
        let ascents = [];
        let selectedGradeId = null;
        let selectedStatus = 'send';
        let startTime = null;
        let isSessionEnded = false;
        let isEditMode = false;

        // Timer (only for active sessions)
        function updateTimer() {
            if (!startTime || isSessionEnded) return;
            
            const now = new Date();
            const diff = Math.floor((now - startTime) / 1000);
            const hours = Math.floor(diff / 3600);
            const minutes = Math.floor((diff % 3600) / 60);
            
            let timeStr = '';
            if (hours > 0) {
                timeStr = `${hours}:${minutes.toString().padStart(2, '0')}h`;
            } else {
                timeStr = `${minutes} min`;
            }
            
            document.getElementById('timer').textContent = timeStr;
        }

        setInterval(updateTimer, 10000);

        async function fetchWithAuth(url, options = {}) {
            return fetch(url, {
                ...options,
                headers: {
                    ...options.headers,
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
        }

        function parseUTCDate(dateStr) {
            if (!dateStr) return null;
            if (dateStr.endsWith('Z') || dateStr.includes('+')) {
                return new Date(dateStr);
            }
            return new Date(dateStr + 'Z');
        }

        function formatDuration(startedAt, endedAt) {
            const start = parseUTCDate(startedAt);
            const end = parseUTCDate(endedAt);
            const diff = Math.floor((end - start) / 60000); // minutes
            const hours = Math.floor(diff / 60);
            const minutes = diff % 60;
            
            if (hours > 0) {
                return `${hours}h ${minutes}min`;
            }
            return `${minutes} minutos`;
        }

        async function loadSession() {
            try {
                const response = await fetchWithAuth(`${API_URL}/sessions/${sessionId}`);
                if (!response.ok) {
                    if (response.status === 403) {
                        alert('No tienes permiso para ver esta sesi√≥n');
                    }
                    window.location.href = '/dashboard';
                    return;
                }
                
                session = await response.json();
                startTime = parseUTCDate(session.started_at);
                isSessionEnded = session.ended_at !== null;
                
                // Check if this is someone else's session
                const isOwnSession = session.is_own !== false;
                
                // Update UI based on session state and ownership
                if (!isOwnSession) {
                    showFriendSessionView();
                } else if (isSessionEnded) {
                    showEndedSessionView();
                } else {
                    showActiveSessionView();
                }
                
                // Show owner name for friend's sessions
                let gymTitle = session.gym_name || 'Sesi√≥n de escalada';
                if (!isOwnSession && session.owner_username) {
                    gymTitle = `${session.owner_username} en ${gymTitle}`;
                }
                
                // Use session title if available
                if (session.title) {
                    document.getElementById('gymName').textContent = session.title;
                } else {
                    document.getElementById('gymName').textContent = gymTitle;
                }
                
                // Show subtitle if available
                if (session.subtitle) {
                    const subtitleEl = document.getElementById('sessionSubtitle');
                    subtitleEl.textContent = session.subtitle;
                    subtitleEl.classList.remove('hidden');
                }
                
                const sessionDate = session.date.includes('T') ? parseUTCDate(session.date) : new Date(session.date + 'T00:00:00');
                const dateStr = sessionDate.toLocaleDateString('es', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                document.getElementById('sessionMeta').innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor" style="width:16px;height:16px;color:#6B7280;display:inline-block;vertical-align:middle;margin-right:4px;"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>${session.gym_name || 'Gimnasio'} ‚Ä¢ ${dateStr}`;
                
                if (session.notes) {
                    document.getElementById('sessionMeta').innerHTML += ` ‚Ä¢ ${session.notes}`;
                }
                
                if (isSessionEnded || !isOwnSession) {
                    if (session.ended_at) {
                        const duration = formatDuration(session.started_at, session.ended_at);
                        document.getElementById('sessionDuration').innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor" style="width:16px;height:16px;color:#6B7280;display:inline-block;vertical-align:middle;margin-right:4px;"><path d="M15 1H9v2h6V1zm-4 13h2V8h-2v6zm8.03-6.61l1.42-1.42c-.43-.51-.9-.99-1.41-1.41l-1.42 1.42C16.07 4.74 14.12 4 12 4c-4.97 0-9 4.03-9 9s4.02 9 9 9 9-4.03 9-9c0-2.12-.74-4.07-1.97-5.61zM12 20c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>Duraci√≥n: ${duration}`;
                        document.getElementById('sessionDuration').classList.remove('hidden');
                    }
                } else {
                    updateTimer();
                }
                
                // Load grades for this gym
                await loadGrades(session.gym_id);
                
                // Load ascents from session data
                ascents = session.ascents || [];
                updateAscentsList();
                updateStats();
                
                if (isSessionEnded || !isOwnSession) {
                    updateGradeBreakdown();
                }
            } catch (error) {
                console.error('Error loading session:', error);
            }
        }

        function showFriendSessionView() {
            // View-only mode for friend's sessions
            document.body.classList.remove('active-session');
            
            // Hide edit button for friend's sessions
            document.getElementById('editTitleBtn').style.display = 'none';
            
            const isActive = !session.ended_at;
            if (isActive) {
                document.getElementById('statusBadge').textContent = 'üü¢ En curso';
                document.getElementById('statusBadge').classList.add('active');
                document.getElementById('statusBadge').classList.remove('ended');
            } else {
                document.getElementById('statusBadge').textContent = '‚úì Completada';
                document.getElementById('statusBadge').classList.remove('active');
                document.getElementById('statusBadge').classList.add('ended');
            }
            
            document.getElementById('timerContainer').classList.add('hidden');
            document.getElementById('gradeSelector').classList.add('hidden');
            document.getElementById('bottomBar').classList.add('hidden');
            document.getElementById('ascentsTitle').textContent = 'Bloques registrados';
            document.getElementById('summarySection').classList.remove('hidden');
        }

        function showActiveSessionView() {
            document.body.classList.add('active-session');
            document.getElementById('statusBadge').textContent = 'üü¢ En curso';
            document.getElementById('statusBadge').classList.remove('ended');
            document.getElementById('statusBadge').classList.add('active');
            document.getElementById('timerContainer').classList.remove('hidden');
            document.getElementById('gradeSelector').classList.remove('hidden');
            document.getElementById('bottomBar').classList.remove('hidden');
            document.getElementById('ascentsTitle').textContent = 'Bloques de hoy';
            document.getElementById('summarySection').classList.add('hidden');
        }

        function showEndedSessionView() {
            document.body.classList.remove('active-session');
            document.getElementById('statusBadge').textContent = '‚úì Completada';
            document.getElementById('statusBadge').classList.remove('active');
            document.getElementById('statusBadge').classList.add('ended');
            document.getElementById('timerContainer').classList.add('hidden');
            document.getElementById('gradeSelector').classList.add('hidden');
            document.getElementById('bottomBar').classList.add('hidden');
            document.getElementById('ascentsTitle').textContent = 'Bloques registrados';
            document.getElementById('summarySection').classList.remove('hidden');
            
            // Show edit and delete buttons
            if (!document.getElementById('editModeBtn')) {
                const summarySection = document.getElementById('summarySection');
                
                const buttonsContainer = document.createElement('div');
                buttonsContainer.id = 'sessionActionButtons';
                buttonsContainer.style.display = 'flex';
                buttonsContainer.style.gap = '1rem';
                buttonsContainer.style.marginTop = '1.5rem';
                buttonsContainer.style.flexWrap = 'wrap';
                
                // Share button
                const shareBtn = document.createElement('button');
                shareBtn.id = 'shareActivityBtn';
                shareBtn.className = 'btn-share';
                shareBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" style="display: inline-block; vertical-align: middle; margin-right: 8px;"><path d="M18 8C19.6569 8 21 6.65685 21 5C21 3.34315 19.6569 2 18 2C16.3431 2 15 3.34315 15 5C15 5.12548 15.0077 5.24917 15.0227 5.37061L8.08259 9.19019C7.54305 8.46365 6.67916 8 5.7 8C3.89117 8 2.42624 9.46493 2.42624 11.274C2.42624 13.0831 3.89117 14.548 5.7 14.548C6.67916 14.548 7.54305 14.0844 8.08259 13.3578L15.0227 17.1774C15.0077 17.2988 15 17.4225 15 17.548C15 19.2049 16.3431 20.548 18 20.548C19.6569 20.548 21 19.2049 21 17.548C21 15.8911 19.6569 14.548 18 14.548C17.021 14.548 16.157 15.0116 15.6174 15.7382L8.67733 11.9186C8.69229 11.7972 8.7 11.6735 8.7 11.548C8.7 11.4225 8.69229 11.2988 8.67733 11.1774L15.6174 7.35777C16.157 8.08431 17.021 8.54793 18 8.54793V8Z" fill="currentColor"/></svg> Compartir actividad';
                shareBtn.onclick = shareActivity;
                shareBtn.style.marginTop = '0';
                shareBtn.style.marginLeft = '0';
                shareBtn.style.flex = '1';
                
                // Strava button (if connected and not already uploaded)
                const stravaBtn = document.createElement('button');
                stravaBtn.id = 'stravaUploadBtn';
                stravaBtn.className = 'btn-strava';
                if (session.strava_activity_id) {
                    stravaBtn.innerHTML = '<img src="/static/icons/strava.png" alt="Strava"> Subido a Strava';
                    stravaBtn.classList.add('uploaded');
                    stravaBtn.onclick = () => {
                        window.open(`https://www.strava.com/activities/${session.strava_activity_id}`, '_blank');
                    };
                } else {
                    stravaBtn.innerHTML = '<img src="/static/icons/strava.png" alt="Strava"> Subir a Strava';
                    stravaBtn.onclick = uploadToStrava;
                }
                stravaBtn.style.marginTop = '0';
                stravaBtn.style.marginLeft = '0';
                
                const editBtn = document.createElement('button');
                editBtn.id = 'editModeBtn';
                editBtn.className = 'btn-reopen';
                editBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" style="display: inline-block; vertical-align: middle; margin-right: 8px;"><path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M18.5 2.50023C18.8978 2.1024 19.4374 1.87891 20 1.87891C20.5626 1.87891 21.1022 2.1024 21.5 2.50023C21.8978 2.89805 22.1213 3.43762 22.1213 4.00023C22.1213 4.56284 21.8978 5.1024 21.5 5.50023L12 15.0002L8 16.0002L9 12.0002L18.5 2.50023Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Editar bloques';
                editBtn.onclick = toggleEditMode;
                editBtn.style.marginTop = '0';
                editBtn.style.marginLeft = '0';
                editBtn.style.flex = '1';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.id = 'deleteSessionBtn';
                deleteBtn.className = 'btn-delete';
                deleteBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" style="display: inline-block; vertical-align: middle; margin-right: 8px;"><path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Eliminar sesi√≥n';
                deleteBtn.onclick = deleteSession;
                deleteBtn.style.marginTop = '0';
                deleteBtn.style.marginLeft = '0';
                deleteBtn.style.flex = '1';
                
                buttonsContainer.appendChild(shareBtn);
                buttonsContainer.appendChild(stravaBtn);
                buttonsContainer.appendChild(editBtn);
                buttonsContainer.appendChild(deleteBtn);
                summarySection.appendChild(buttonsContainer);
            }
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            const editBtn = document.getElementById('editModeBtn');
            const gradeSelector = document.getElementById('gradeSelector');
            
            if (isEditMode) {
                editBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" style="display: inline-block; vertical-align: middle; margin-right: 8px;"><path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Terminar edici√≥n';
                editBtn.classList.remove('btn-reopen');
                editBtn.classList.add('btn-primary');
                gradeSelector.classList.remove('hidden');
                document.getElementById('statusBadge').textContent = '‚úèÔ∏è Editando';
                document.getElementById('statusBadge').style.background = 'var(--flash)';
                // Reload ascents to show delete buttons
                updateAscentsList();
            } else {
                editBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" style="display: inline-block; vertical-align: middle; margin-right: 8px;"><path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M18.5 2.50023C18.8978 2.1024 19.4374 1.87891 20 1.87891C20.5626 1.87891 21.1022 2.1024 21.5 2.50023C21.8978 2.89805 22.1213 3.43762 22.1213 4.00023C22.1213 4.56284 21.8978 5.1024 21.5 5.50023L12 15.0002L8 16.0002L9 12.0002L18.5 2.50023Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Editar bloques';
                editBtn.classList.add('btn-reopen');
                editBtn.classList.remove('btn-primary');
                gradeSelector.classList.add('hidden');
                document.getElementById('statusBadge').textContent = '‚úì Completada';
                document.getElementById('statusBadge').style.background = '';
                // Reload ascents to hide delete buttons
                updateAscentsList();
            }
        }

        async function loadGrades(gymId) {
            try {
                const response = await fetch(`${API_URL}/gyms/${gymId}/grades`);
                grades = await response.json();
                
                // Render grade selector (hidden initially for ended sessions)
                const container = document.getElementById('gradesGrid');
                
                if (grades.length === 0) {
                    container.innerHTML = '<p>No hay grados configurados</p>';
                    return;
                }
                
                container.innerHTML = grades.map(grade => `
                    <button type="button" class="grade-btn" 
                            data-grade-id="${grade.id}"
                            style="background: ${grade.color_hex || '#666'}">
                        <span class="grade-name">${grade.label}</span>
                    </button>
                `).join('');
                
                // Add click handlers
                document.querySelectorAll('.grade-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.grade-btn').forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                        selectedGradeId = parseInt(btn.dataset.gradeId);
                        updateAddButton();
                    });
                });
            } catch (error) {
                console.error('Error loading grades:', error);
            }
        }

        async function loadAscents() {
            try {
                const response = await fetchWithAuth(`${API_URL}/sessions/${sessionId}/ascents`);
                if (!response.ok) {
                    console.error('Error loading ascents:', response.status);
                    return;
                }
                ascents = await response.json();
                
                updateAscentsList();
                updateStats();
                
                if (isSessionEnded) {
                    updateGradeBreakdown();
                }
            } catch (error) {
                console.error('Error loading ascents:', error);
            }
        }

        function updateAscentsList() {
            const container = document.getElementById('ascentsList');
            
            if (ascents.length === 0) {
                container.innerHTML = '<div class="empty-ascents">No se registraron bloques en esta sesi√≥n</div>';
                return;
            }
            
            container.innerHTML = ascents.map(ascent => {
                const grade = grades.find(g => g.id === ascent.grade_id) || {};
                const statusIcon = {
                    'flash': '<svg viewBox="0 0 24 24" fill="currentColor" style="width:20px;height:20px;color:#F59E0B;"><path d="M7 2v11h3v9l7-12h-4l4-8z"/></svg>',
                    'send': '<svg viewBox="0 0 24 24" fill="currentColor" style="width:20px;height:20px;color:#22C55E;"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>',
                    'repeat': '<svg viewBox="0 0 24 24" fill="currentColor" style="width:20px;height:20px;color:#2EC4B6;"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>',
                    'project': '<svg viewBox="0 0 24 24" fill="currentColor" style="width:20px;height:20px;color:#F59E0B;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>'
                }[ascent.status] || '<svg viewBox="0 0 24 24" fill="currentColor" style="width:20px;height:20px;color:#22C55E;"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';
                
                const time = parseUTCDate(ascent.created_at).toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' });
                
                // Only show delete button for active sessions
                // Show delete button if session is active OR in edit mode
                const showDelete = !isSessionEnded || isEditMode;
                const deleteBtn = showDelete ? `<button class="ascent-delete" onclick="deleteAscent(${ascent.id})"><svg viewBox="0 0 24 24" fill="currentColor" style="width:18px;height:18px;"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>` : '';
                
                return `
                    <div class="ascent-item">
                        <div class="ascent-grade" style="background: ${grade.color_hex || '#666'}">
                            ${grade.label || '?'}
                        </div>
                        <div class="ascent-info">
                            <div class="grade-label">${grade.label || 'Grado'}</div>
                            <div class="time">${time}</div>
                        </div>
                        <div class="ascent-status">${statusIcon}</div>
                        ${deleteBtn}
                    </div>
                `;
            }).join('');
        }

        function updateStats() {
            const total = ascents.length;
            const flashes = ascents.filter(a => a.status === 'flash').length;
            const sends = ascents.filter(a => a.status === 'send' || a.status === 'flash').length;
            
            let maxGradeLabel = '-';
            let maxDifficulty = 0;
            
            ascents.forEach(ascent => {
                if (ascent.status !== 'repeat' && ascent.status !== 'project') {
                    const grade = grades.find(g => g.id === ascent.grade_id);
                    if (grade && grade.relative_difficulty > maxDifficulty) {
                        maxDifficulty = grade.relative_difficulty;
                        maxGradeLabel = grade.label;
                    }
                }
            });
            
            document.getElementById('totalAscents').textContent = total;
            document.getElementById('totalFlashes').textContent = flashes;
            document.getElementById('totalSends').textContent = sends;
            document.getElementById('maxGrade').textContent = maxGradeLabel;
        }

        function updateGradeBreakdown() {
            const container = document.getElementById('gradeBreakdown');
            
            // Group ascents by grade
            const gradeMap = new Map();
            ascents.forEach(ascent => {
                const gradeId = ascent.grade_id;
                if (!gradeMap.has(gradeId)) {
                    gradeMap.set(gradeId, { flash: 0, send: 0, repeat: 0, project: 0 });
                }
                gradeMap.get(gradeId)[ascent.status]++;
            });
            
            if (gradeMap.size === 0) {
                container.innerHTML = '<p style="color: var(--gray);">No hay bloques registrados</p>';
                return;
            }
            
            // Sort grades by difficulty
            const sortedGrades = Array.from(gradeMap.entries())
                .map(([gradeId, counts]) => {
                    const grade = grades.find(g => g.id === gradeId) || {};
                    return { grade, counts };
                })
                .sort((a, b) => (b.grade.relative_difficulty || 0) - (a.grade.relative_difficulty || 0));
            
            container.innerHTML = sortedGrades.map(({ grade, counts }) => {
                const total = counts.flash + counts.send + counts.repeat + counts.project;
                let details = [];
                if (counts.flash > 0) details.push(`${counts.flash} <svg viewBox="0 0 24 24" fill="currentColor" style="width:16px;height:16px;color:#F59E0B;display:inline-block;vertical-align:middle;"><path d="M7 2v11h3v9l7-12h-4l4-8z"/></svg>`);
                if (counts.send > 0) details.push(`${counts.send} <svg viewBox="0 0 24 24" fill="currentColor" style="width:16px;height:16px;color:#22C55E;display:inline-block;vertical-align:middle;"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>`);
                if (counts.repeat > 0) details.push(`${counts.repeat} <svg viewBox="0 0 24 24" fill="currentColor" style="width:16px;height:16px;color:#2EC4B6;display:inline-block;vertical-align:middle;"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>`);
                if (counts.project > 0) details.push(`${counts.project} <svg viewBox="0 0 24 24" fill="currentColor" style="width:16px;height:16px;color:#F59E0B;display:inline-block;vertical-align:middle;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>`);
                
                return `
                    <div class="grade-row">
                        <div class="grade-color" style="background: ${grade.color_hex || '#666'}">
                            ${grade.label || '?'}
                        </div>
                        <div class="grade-info">
                            <div class="grade-name">${grade.label || 'Grado'}</div>
                            <div class="grade-count">${total} bloque${total !== 1 ? 's' : ''} ‚Ä¢ ${details.join(' ')}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Status buttons (only for active sessions)
        document.querySelectorAll('.status-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedStatus = btn.dataset.status;
            });
        });

        // Default status
        document.querySelector('.status-btn.send').classList.add('selected');

        function updateAddButton() {
            document.getElementById('addAscentBtn').disabled = !selectedGradeId;
        }

        document.getElementById('addAscentBtn').addEventListener('click', async () => {
            // Allow adding if session is active OR in edit mode
            if (!selectedGradeId || (isSessionEnded && !isEditMode)) return;
            
            try {
                const response = await fetchWithAuth(`${API_URL}/sessions/${sessionId}/ascents`, {
                    method: 'POST',
                    body: JSON.stringify({
                        grade_id: selectedGradeId,
                        status: selectedStatus
                    })
                });
                
                if (response.ok) {
                    loadAscents();
                    
                    // Brief visual feedback
                    const btn = document.getElementById('addAscentBtn');
                    btn.textContent = '‚úì A√±adido!';
                    setTimeout(() => {
                        btn.textContent = '+ A√±adir bloque';
                    }, 1000);
                }
            } catch (error) {
                console.error('Error adding ascent:', error);
            }
        });

        async function deleteAscent(ascentId) {
            if (!confirm('¬øEliminar este bloque?')) return;
            
            try {
                await fetchWithAuth(`${API_URL}/ascents/${ascentId}`, {
                    method: 'DELETE'
                });
                loadAscents();
            } catch (error) {
                console.error('Error deleting ascent:', error);
            }
        }

        async function endSession() {
            if (isSessionEnded) return;
            if (!confirm('¬øTerminar la sesi√≥n de hoy?')) return;
            
            try {
                await fetchWithAuth(`${API_URL}/sessions/${sessionId}/end`, {
                    method: 'POST'
                });
                // Reload the page to show the ended session summary
                window.location.reload();
            } catch (error) {
                console.error('Error ending session:', error);
                window.location.reload();
            }
        }

        async function uploadToStrava() {
            const btn = document.getElementById('stravaUploadBtn');
            
            // Check if already uploaded
            if (session.strava_activity_id) {
                // Already uploaded, just open the activity
                window.open(`https://www.strava.com/activities/${session.strava_activity_id}`, '_blank');
                return;
            }
            
            if (!confirm('¬øSubir esta sesi√≥n a Strava?')) {
                return;
            }
            
            // Disable button and show loading
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Subiendo...';
            
            try {
                const response = await fetchWithAuth(`${API_URL}/strava/upload-session/${sessionId}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Check if it was already uploaded
                    if (data.already_uploaded) {
                        session.strava_activity_id = data.strava_activity_id;
                        btn.innerHTML = '‚úì Ver en Strava';
                        btn.classList.add('uploaded');
                        btn.disabled = false;
                        btn.onclick = () => {
                            window.open(data.strava_url, '_blank');
                        };
                        alert('Esta sesi√≥n ya estaba subida a Strava');
                    } else {
                        session.strava_activity_id = data.strava_activity_id;
                        
                        // Update button
                        btn.innerHTML = '‚úì Ver en Strava';
                        btn.classList.add('uploaded');
                        btn.disabled = false;
                        btn.onclick = () => {
                            window.open(data.strava_url, '_blank');
                        };
                        
                        alert('‚úì Sesi√≥n subida a Strava correctamente');
                    }
                } else {
                    const error = await response.json();
                    btn.disabled = false;
                    btn.innerHTML = 'üèÉ Subir a Strava';
                    
                    if (error.detail && error.detail.includes('not connected')) {
                        alert('Conecta tu cuenta de Strava en el perfil primero');
                    } else {
                        alert('Error al subir a Strava: ' + (error.detail || 'Error desconocido'));
                    }
                }
            } catch (error) {
                console.error('Error uploading to Strava:', error);
                btn.disabled = false;
                btn.innerHTML = 'üèÉ Subir a Strava';
                alert('Error al subir a Strava');
            }
        }

        async function deleteSession() {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar esta sesi√≥n? Se borrar√°n todos los bloques registrados.')) return;
            if (!confirm('Esta acci√≥n no se puede deshacer. ¬øContinuar?')) return;
            
            try {
                const response = await fetchWithAuth(`${API_URL}/sessions/${sessionId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    window.location.href = '/sessions';
                } else {
                    alert('Error al eliminar la sesi√≥n');
                }
            } catch (error) {
                console.error('Error deleting session:', error);
                alert('Error al eliminar la sesi√≥n');
            }
        }

        // Title editing functionality
        document.getElementById('editTitleBtn').addEventListener('click', () => {
            const editor = document.getElementById('titleEditor');
            const titleEl = document.getElementById('sessionTitle');
            const subtitleEl = document.getElementById('sessionSubtitle');
            
            // Populate inputs with current values
            document.getElementById('editTitleInput').value = session.title || '';
            document.getElementById('editSubtitleInput').value = session.subtitle || '';
            
            // Show editor, hide title
            editor.classList.add('active');
            titleEl.style.display = 'none';
            subtitleEl.style.display = 'none';
            
            document.getElementById('editTitleInput').focus();
        });

        document.getElementById('cancelTitleBtn').addEventListener('click', () => {
            document.getElementById('titleEditor').classList.remove('active');
            document.getElementById('sessionTitle').style.display = 'flex';
            const subtitleEl = document.getElementById('sessionSubtitle');
            if (session.subtitle) {
                subtitleEl.style.display = 'block';
            }
        });

        async function shareActivity() {
            const btn = document.getElementById('shareActivityBtn');
            btn.disabled = true;
            btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" style="display: inline-block; vertical-align: middle; margin-right: 8px; animation: spin 1s linear infinite;"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" opacity="0.25"/><path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="4" fill="none" stroke-linecap="round"/></svg> Generando imagen...';
            
            try {
                // Create canvas
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Set canvas size (Instagram-friendly 1080x1350)
                canvas.width = 1080;
                canvas.height = 1350;
                
                // Background gradient
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, '#1A1A2E');
                gradient.addColorStop(1, '#16213E');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Load and draw logo
                const logo = new Image();
                logo.src = '/static/icons/logoChalkin_invertido_180.png';
                await new Promise((resolve) => {
                    logo.onload = resolve;
                });
                
                const logoSize = 100;
                ctx.drawImage(logo, 50, 50, logoSize, logoSize);
                
                // Add "Chalkin" text next to logo
                ctx.fillStyle = '#FF6B35';
                ctx.font = 'bold 60px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                ctx.fillText('Chalkin', 170, 110);
                
                // Session title
                ctx.fillStyle = 'white';
                ctx.font = 'bold 48px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                const title = session.title || session.gym_name || 'Sesi√≥n de escalada';
                ctx.fillText(title, 50, 230);
                
                // Session subtitle (if available)
                if (session.subtitle) {
                    ctx.fillStyle = '#9CA3AF';
                    ctx.font = '32px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                    ctx.fillText(session.subtitle, 50, 280);
                }
                
                // Gym name
                const yOffset = session.subtitle ? 330 : 280;
                ctx.fillStyle = '#2EC4B6';
                ctx.font = 'bold 32px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                ctx.fillText(`üìç ${session.gym_name || 'Gimnasio'}`, 50, yOffset);
                
                // Date
                const sessionDate = session.date.includes('T') ? parseUTCDate(session.date) : new Date(session.date + 'T00:00:00');
                const dateStr = sessionDate.toLocaleDateString('es', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                ctx.fillStyle = '#9CA3AF';
                ctx.font = '32px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                ctx.fillText(dateStr, 50, yOffset + 50);
                
                // Duration
                if (session.ended_at) {
                    const duration = formatDuration(session.started_at, session.ended_at);
                    ctx.fillText(`‚è±Ô∏è ${duration}`, 50, yOffset + 100);
                }
                
                // Main stats box
                const statsY = yOffset + 170;
                ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
                ctx.fillRect(50, statsY, canvas.width - 100, 200);
                
                const total = ascents.length;
                const flashes = ascents.filter(a => a.status === 'flash').length;
                const sends = ascents.filter(a => a.status === 'send' || a.status === 'flash').length;
                
                let maxGradeLabel = '-';
                let maxDifficulty = 0;
                ascents.forEach(ascent => {
                    if (ascent.status !== 'repeat' && ascent.status !== 'project') {
                        const grade = grades.find(g => g.id === ascent.grade_id);
                        if (grade && grade.relative_difficulty > maxDifficulty) {
                            maxDifficulty = grade.relative_difficulty;
                            maxGradeLabel = grade.label;
                        }
                    }
                });
                
                // Stats grid
                const stats = [
                    { label: 'Bloques', value: total, emoji: 'üßó' },
                    { label: 'Flashes', value: flashes, emoji: '‚ö°' },
                    { label: 'Encadenados', value: sends, emoji: '‚úÖ' },
                    { label: 'M√°x grado', value: maxGradeLabel, emoji: 'üî•' }
                ];
                
                const statWidth = (canvas.width - 100) / 4;
                stats.forEach((stat, i) => {
                    const x = 50 + i * statWidth;
                    const centerX = x + statWidth / 2;
                    
                    // Emoji - centered
                    ctx.fillStyle = 'white';
                    ctx.font = '60px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(stat.emoji, centerX, statsY + 70);
                    
                    // Value
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 48px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(stat.value.toString(), centerX, statsY + 135);
                    
                    // Label
                    ctx.fillStyle = '#9CA3AF';
                    ctx.font = '24px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(stat.label, centerX, statsY + 170);
                    
                    ctx.textAlign = 'left';
                });
                
                // Grade breakdown
                const breakdownY = statsY + 250;
                
                // Group ascents by grade
                const gradeMap = new Map();
                ascents.forEach(ascent => {
                    const gradeId = ascent.grade_id;
                    if (!gradeMap.has(gradeId)) {
                        gradeMap.set(gradeId, { flash: 0, send: 0, repeat: 0, project: 0 });
                    }
                    gradeMap.get(gradeId)[ascent.status]++;
                });
                
                // Sort grades by difficulty
                const sortedGrades = Array.from(gradeMap.entries())
                    .map(([gradeId, counts]) => {
                        const grade = grades.find(g => g.id == gradeId) || {};
                        return { grade, counts };
                    })
                    .sort((a, b) => (b.grade.relative_difficulty || 0) - (a.grade.relative_difficulty || 0))
                    .slice(0, 12); // Increased to 12 grades (6 per column)
                
                // Two column layout
                const columnWidth = (canvas.width - 100) / 2;
                const boxWidth = 200;
                const boxHeight = 110;
                const rowHeight = 130;
                
                sortedGrades.forEach(({ grade, counts }, index) => {
                    const total = counts.flash + counts.send + counts.repeat + counts.project;
                    
                    // Calculate position (two columns)
                    const column = index % 2;
                    const row = Math.floor(index / 2);
                    const xOffset = 50 + column * columnWidth;
                    const gradeY = breakdownY + row * rowHeight;
                    
                    // Grade color box
                    ctx.fillStyle = grade.color_hex || '#666';
                    ctx.fillRect(xOffset, gradeY, boxWidth, boxHeight);
                    
                    // Grade label in box
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 40px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(grade.label || '?', xOffset + boxWidth / 2, gradeY + boxHeight / 2 + 14);
                    ctx.textAlign = 'left';
                    
                    // Grade details
                    const detailsX = xOffset + boxWidth + 15;
                    const centerY = gradeY + boxHeight / 2;
                    
                    // Total blocks - centered vertically
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 36px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                    ctx.fillText(`${total} bloque${total !== 1 ? 's' : ''}`, detailsX, centerY - 10);
                    
                    // Detailed breakdown with labels - centered vertically below total
                    let details = [];
                    if (counts.flash > 0) details.push(`${counts.flash} Flash${counts.flash !== 1 ? 'es' : ''}`);
                    if (counts.send > 0) details.push(`${counts.send} Encadenado${counts.send !== 1 ? 's' : ''}`);
                    if (counts.repeat > 0) details.push(`${counts.repeat} Repetici√≥n${counts.repeat !== 1 ? 'es' : ''}`);
                    if (counts.project > 0) details.push(`${counts.project} Proyecto${counts.project !== 1 ? 's' : ''}`);
                    
                    ctx.fillStyle = '#9CA3AF';
                    ctx.font = '26px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                    ctx.fillText(details.join(' ‚Ä¢ '), detailsX, centerY + 30);
                });
                
                // Footer text
                ctx.fillStyle = '#6B7280';
                ctx.font = '24px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Hecho con Chalkin', canvas.width / 2, canvas.height - 30);
                ctx.textAlign = 'left';
                
                // Convert canvas to blob and share (not download)
                canvas.toBlob(async (blob) => {
                    const file = new File([blob], 'chalkin-session.png', { type: 'image/png' });
                    const sessionUrl = window.location.href;
                    const shareText = `${title} - ${total} bloques registrados\n\nüîó Ver sesi√≥n: ${sessionUrl}`;
                    
                    btn.disabled = false;
                    btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" style="display: inline-block; vertical-align: middle; margin-right: 8px;"><path d="M18 8C19.6569 8 21 6.65685 21 5C21 3.34315 19.6569 2 18 2C16.3431 2 15 3.34315 15 5C15 5.12548 15.0077 5.24917 15.0227 5.37061L8.08259 9.19019C7.54305 8.46365 6.67916 8 5.7 8C3.89117 8 2.42624 9.46493 2.42624 11.274C2.42624 13.0831 3.89117 14.548 5.7 14.548C6.67916 14.548 7.54305 14.0844 8.08259 13.3578L15.0227 17.1774C15.0077 17.2988 15 17.4225 15 17.548C15 19.2049 16.3431 20.548 18 20.548C19.6569 20.548 21 19.2049 21 17.548C21 15.8911 19.6569 14.548 18 14.548C17.021 14.548 16.157 15.0116 15.6174 15.7382L8.67733 11.9186C8.69229 11.7972 8.7 11.6735 8.7 11.548C8.7 11.4225 8.69229 11.2988 8.67733 11.1774L15.6174 7.35777C16.157 8.08431 17.021 8.54793 18 8.54793V8Z" fill="currentColor"/></svg> Compartir actividad';
                    
                    // Try to share via Web Share API
                    if (navigator.share) {
                        try {
                            // Check if we can share files
                            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                                await navigator.share({
                                    files: [file],
                                    title: 'Mi sesi√≥n de escalada en Chalkin',
                                    text: shareText
                                });
                            } else {
                                // Share only text and URL
                                await navigator.share({
                                    title: 'Mi sesi√≥n de escalada en Chalkin',
                                    text: shareText
                                });
                            }
                        } catch (err) {
                            if (err.name !== 'AbortError') {
                                console.log('Error sharing:', err);
                                // Fallback: offer to download the image
                                if (confirm('No se pudo compartir. ¬øDeseas descargar la imagen?')) {
                                    const url = URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = `chalkin-${session.gym_name || 'sesion'}-${new Date().getTime()}.png`;
                                    a.click();
                                    URL.revokeObjectURL(url);
                                }
                            }
                        }
                    } else {
                        // Fallback for browsers without Web Share API
                        if (confirm('Tu navegador no soporta compartir. ¬øDeseas descargar la imagen?')) {
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `chalkin-${session.gym_name || 'sesion'}-${new Date().getTime()}.png`;
                            a.click();
                            URL.revokeObjectURL(url);
                        }
                    }
                }, 'image/png');
                
            } catch (error) {
                console.error('Error generating image:', error);
                btn.disabled = false;
                btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" style="display: inline-block; vertical-align: middle; margin-right: 8px;"><path d="M18 8C19.6569 8 21 6.65685 21 5C21 3.34315 19.6569 2 18 2C16.3431 2 15 3.34315 15 5C15 5.12548 15.0077 5.24917 15.0227 5.37061L8.08259 9.19019C7.54305 8.46365 6.67916 8 5.7 8C3.89117 8 2.42624 9.46493 2.42624 11.274C2.42624 13.0831 3.89117 14.548 5.7 14.548C6.67916 14.548 7.54305 14.0844 8.08259 13.3578L15.0227 17.1774C15.0077 17.2988 15 17.4225 15 17.548C15 19.2049 16.3431 20.548 18 20.548C19.6569 20.548 21 19.2049 21 17.548C21 15.8911 19.6569 14.548 18 14.548C17.021 14.548 16.157 15.0116 15.6174 15.7382L8.67733 11.9186C8.69229 11.7972 8.7 11.6735 8.7 11.548C8.7 11.4225 8.69229 11.2988 8.67733 11.1774L15.6174 7.35777C16.157 8.08431 17.021 8.54793 18 8.54793V8Z" fill="currentColor"/></svg> Compartir actividad';
                alert('Error al generar la imagen');
            }
        }

        document.getElementById('saveTitleBtn').addEventListener('click', async () => {
            const newTitle = document.getElementById('editTitleInput').value.trim() || null;
            const newSubtitle = document.getElementById('editSubtitleInput').value.trim() || null;
            
            try {
                const response = await fetchWithAuth(`${API_URL}/sessions/${sessionId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        title: newTitle,
                        subtitle: newSubtitle
                    })
                });
                
                if (response.ok) {
                    // Update local session data
                    session.title = newTitle;
                    session.subtitle = newSubtitle;
                    
                    // Update UI
                    const titleEl = document.getElementById('sessionTitle');
                    const gymNameEl = document.getElementById('gymName');
                    const subtitleEl = document.getElementById('sessionSubtitle');
                    
                    if (newTitle) {
                        gymNameEl.textContent = newTitle;
                    } else {
                        gymNameEl.textContent = session.gym_name || 'Sesi√≥n de escalada';
                    }
                    
                    if (newSubtitle) {
                        subtitleEl.textContent = newSubtitle;
                        subtitleEl.classList.remove('hidden');
                        subtitleEl.style.display = 'block';
                    } else {
                        subtitleEl.textContent = '';
                        subtitleEl.classList.add('hidden');
                        subtitleEl.style.display = 'none';
                    }
                    
                    // Hide editor, show title
                    document.getElementById('titleEditor').classList.remove('active');
                    titleEl.style.display = 'flex';
                } else {
                    alert('Error al guardar');
                }
            } catch (error) {
                console.error('Error saving title:', error);
                alert('Error al guardar');
            }
        });

        loadSession();
    </script>
</body>
</html>
