name: Deploy to Production

on:
  workflow_run:
    workflows: ["Python tests"]
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Solo deploy si los tests pasaron
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Deploy to server
        env:
          SSH_HOST: ${{ secrets.SERVER_HOST }}
          SSH_USER: ${{ secrets.SERVER_USER }}
          SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Crear config SSH para evitar problemas con IPv6
          cat > ~/.ssh/config << SSHCONFIG
          Host deploy-target
            HostName ${SSH_HOST}
            User ${SSH_USER}
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          SSHCONFIG
          chmod 600 ~/.ssh/config
          
          # Ejecutar deploy
          ssh deploy-target 'cd ~/chalkin && git pull origin main && docker compose -f docker-compose.prod.yml up -d --build && docker compose -f docker-compose.prod.yml exec -T api alembic upgrade head && echo "âœ… Deployed at $(date)"'
